version: '3.9'

services:
  # EventStoreDB - Event Sourcing Database
  eventstoredb:
    image: eventstore/eventstore:23.10.0-bookworm-slim
    container_name: cap-bsp-dsp-eventstoredb
    environment:
      - EVENTSTORE_CLUSTER_SIZE=1
      - EVENTSTORE_RUN_PROJECTIONS=All
      - EVENTSTORE_START_STANDARD_PROJECTIONS=true
      - EVENTSTORE_HTTP_PORT=2113
      - EVENTSTORE_INT_IP=0.0.0.0
      - EVENTSTORE_EXT_IP=0.0.0.0
      - EVENTSTORE_INSECURE=true
      - EVENTSTORE_ENABLE_ATOM_PUB_OVER_HTTP=true
    ports:
      - "2113:2113"  # HTTP
      - "1113:1113"  # TCP
    volumes:
      - eventstoredb-data:/var/lib/eventstore
      - eventstoredb-logs:/var/log/eventstore
      - ../infrastructure/local/eventstoredb.yaml:/etc/eventstore/eventstore.conf:ro
    networks:
      - cap-bsp-dsp
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:2113/health/live || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # MongoDB - Read Model Database
  mongodb:
    image: mongo:7.0
    container_name: cap-bsp-dsp-mongodb
    environment:
      - MONGO_INITDB_ROOT_USERNAME=admin
      - MONGO_INITDB_ROOT_PASSWORD=admin123
      - MONGO_INITDB_DATABASE=cap_bsp_dsp
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
      - ./init-scripts/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
    networks:
      - cap-bsp-dsp
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # RabbitMQ - Message Broker
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    container_name: cap-bsp-dsp-rabbitmq
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
      - RABBITMQ_DEFAULT_VHOST=/
    ports:
      - "5672:5672"   # AMQP
      - "15672:15672" # Management UI
    volumes:
      - rabbitmq-data:/var/lib/rabbitmq
    networks:
      - cap-bsp-dsp
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Jaeger - Distributed Tracing
  jaeger:
    image: jaegertracing/all-in-one:1.54
    container_name: cap-bsp-dsp-jaeger
    environment:
      - COLLECTOR_OTLP_ENABLED=true
    ports:
      - "16686:16686" # Jaeger UI
      - "14268:14268" # Jaeger collector HTTP
      - "14250:14250" # Jaeger collector gRPC
      - "4317:4317"   # OTLP gRPC
      - "4318:4318"   # OTLP HTTP
    networks:
      - cap-bsp-dsp
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:16686"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:v2.49.1
    container_name: cap-bsp-dsp-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - cap-bsp-dsp
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  cap-bsp-dsp:
    driver: bridge

volumes:
  eventstoredb-data:
  eventstoredb-logs:
  mongodb-data:
  rabbitmq-data:
  prometheus-data:
